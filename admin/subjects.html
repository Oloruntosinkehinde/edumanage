<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tophill Portal - Subject Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../shared/styles.css">

</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="toggle-btn" id="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h3>Tophill Portal</h3>
            </div>
            <div class="sidebar-menu">
                <a href="admin-dashboard.html" class="menu-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
                <a href="students.html" class="menu-item"><i class="fas fa-users"></i><span>Students</span></a>
                <a href="teachers.html" class="menu-item"><i class="fas fa-chalkboard-teacher"></i><span>Teachers</span></a>
                <a href="subjects.html" class="menu-item active"><i class="fas fa-book"></i><span>Subjects</span></a>
                <a href="results.html" class="menu-item"><i class="fas fa-clipboard-list"></i><span>Results</span></a>
                <a href="payments.html" class="menu-item"><i class="fas fa-credit-card"></i><span>Payments</span></a>
                <a href="user-management.html" class="menu-item"><i class="fas fa-user-cog"></i><span>User Management</span></a>
                <a href="feed.html" class="menu-item"><i class="fas fa-bullhorn"></i><span>Feed</span></a>
                <a href="settings.html" class="menu-item"><i class="fas fa-cog"></i><span>Settings</span></a>
                <a href="../student/student-login.html" class="menu-item" style="color:inherit;text-decoration:none;"><i class="fas fa-user-graduate"></i><span>Student Portal</span></a>
                <a href="../teacher/teacher-login.html" class="menu-item" style="color:inherit;text-decoration:none;"><i class="fas fa-chalkboard-teacher"></i><span>Teacher Portal</span></a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div>
                    <button class="menu-toggle" id="mobile-menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <span class="header-title">Subject Management</span>
                    <div class="session-info" style="margin-left: 20px; font-size: 14px; color: #666;">
                        ðŸ“… Session: <span id="current-session">2025-2026</span> | 
                        ðŸ“š Term: <span id="current-term">First Term</span>
                    </div>
                </div>
                <div class="user-info">
                    <button class="btn btn-primary" onclick="uploadCSV()" style="margin-right: 10px;">
                        <i class="fas fa-upload"></i> Upload CSV
                    </button>
                    <button class="btn btn-primary" onclick="downloadPDF('subjects')" style="margin-right: 15px;">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=random" alt="User">
                    <span>Admin User</span>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                </div>
            </div>

            <!-- Subjects Page -->
            <div class="page-content active" id="subjects">
                <!-- Page Hero -->
                <div class="page-hero">
                    <div class="hero-content">
                        <div class="hero-text">
                            <h1 class="hero-title">
                                <i class="fas fa-book"></i>
                                Subject Management
                            </h1>
                            <p class="hero-subtitle">
                                Manage all subjects, assign teachers to classes, and oversee academic curriculum across different grade levels.
                            </p>
                        </div>
                        <div class="hero-actions">
                            <button class="btn btn-primary" onclick="showAddSubjectModal()">
                                <i class="fas fa-plus"></i> New Subject
                            </button>
                            <button class="btn btn-secondary" onclick="downloadPDF('subjects')">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="hero-meta">
                        <span class="meta-pill">
                            <i class="fas fa-calendar-alt"></i>
                            Session: <span id="current-session">2025-2026</span>
                        </span>
                        <span class="meta-pill">
                            <i class="fas fa-book-reader"></i>
                            Term: <span id="current-term">First Term</span>
                        </span>
                    </div>
                </div>

                <div class="content-section">
                    <div class="tabs">
                        <div class="tab active" data-tab="subjects-list">Subjects</div>
                        <div class="tab" data-tab="classes-list">Classes</div>
                        <div class="tab" data-tab="scores-entry">Enter Scores</div>
                    </div>

                    <div class="tab-content active" id="subjects-list">
                        <div class="section-header">
                            <div class="section-title">Subject Management</div>
                            <button class="btn btn-primary" onclick="showAddSubjectModal()">Add New Subject</button>
                        </div>
                        
                        <!-- Subject Summary Cards -->
                        <div class="subject-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                            <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px;">
                                <div class="summary-icon" style="font-size: 1.5rem; margin-bottom: 8px;">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div class="summary-title">Total Subjects</div>
                                <div class="summary-value" id="total-subjects">0</div>
                            </div>
                            <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 8px;">
                                <div class="summary-icon" style="font-size: 1.5rem; margin-bottom: 8px;">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                </div>
                                <div class="summary-title">Active Teachers</div>
                                <div class="summary-value" id="active-teachers">0</div>
                            </div>
                            <div class="summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 8px;">
                                <div class="summary-icon" style="font-size: 1.5rem; margin-bottom: 8px;">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="summary-title">Classes Covered</div>
                                <div class="summary-value" id="classes-covered">0</div>
                            </div>
                            <div class="summary-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 15px; border-radius: 8px;">
                                <div class="summary-icon" style="font-size: 1.5rem; margin-bottom: 8px;">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="summary-title">Current Session</div>
                                <div class="summary-value" id="session-display">2025-2026</div>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="filters-section" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div class="filter-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                <div class="filter-group">
                                    <label for="subject-filter-teacher">Teacher:</label>
                                    <select id="subject-filter-teacher" class="form-control">
                                        <option value="">All Teachers</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="subject-filter-class">Class:</label>
                                    <select id="subject-filter-class" class="form-control">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="subject-filter-status">Status:</label>
                                    <select id="subject-filter-status" class="form-control">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="subject-search">Search:</label>
                                    <input type="text" id="subject-search" class="form-control" placeholder="Search subjects...">
                                </div>
                            </div>
                            <div class="filter-actions" style="display: flex; gap: 10px;">
                                <button class="btn btn-secondary" id="apply-subject-filters">
                                    <i class="fas fa-filter"></i> Apply Filters
                                </button>
                                <button class="btn btn-outline-secondary" id="clear-subject-filters">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table" id="subjects-table">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Subject Name</th>
                                        <th>Teacher</th>
                                        <th>Classes</th>
                                        <th>Credits</th>
                                        <th>Students</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="subjects-table-body">
                                    <!-- Dynamic content will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-content" id="classes-list">
                        <div class="section-header">
                            <div class="section-title">Class Management</div>
                            <button class="btn btn-primary">Add New Class</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Class ID</th>
                                    <th>Class Name</th>
                                    <th>Students</th>
                                    <th>Class Teacher</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>CLS10A</td>
                                    <td>10-A</td>
                                    <td>32</td>
                                    <td>Mr. Johnson</td>
                                    <td>
                                        <i class="fas fa-edit" style="color: var(--info); margin-right: 10px; cursor: pointer;"></i>
                                        <i class="fas fa-trash" style="color: var(--danger); cursor: pointer;"></i>
                                    </td>
                                </tr>
                                <tr>
                                    <td>CLS10B</td>
                                    <td>10-B</td>
                                    <td>28</td>
                                    <td>Ms. Williams</td>
                                    <td>
                                        <i class="fas fa-edit" style="color: var(--info); margin-right: 10px; cursor: pointer;"></i>
                                        <i class="fas fa-trash" style="color: var(--danger); cursor: pointer;"></i>
                                    </td>
                                </tr>
                                <tr>
                                    <td>CLS11A</td>
                                    <td>11-A</td>
                                    <td>35</td>
                                    <td>Dr. Smith</td>
                                    <td>
                                        <i class="fas fa-edit" style="color: var(--info); margin-right: 10px; cursor: pointer;"></i>
                                        <i class="fas fa-trash" style="color: var(--danger); cursor: pointer;"></i>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="tab-content" id="scores-entry">
                        <div class="section-header">
                            <div class="section-title">Enter Test Scores</div>
                        </div>
                        <form id="scores-entry-form">
                            <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label class="form-label">Session:</label>
                                    <select id="scores-session" class="form-control" required>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Term:</label>
                                    <select id="scores-term" class="form-control" required>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Select Class:</label>
                                    <select id="scores-class" class="form-control" required>
                                        <option value="">Choose Class</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Select Subject:</label>
                                    <select id="scores-subject" class="form-control" required>
                                        <option value="">Choose Subject</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label class="form-label">Test Type:</label>
                                    <select id="scores-test-type" class="form-control" required>
                                        <option value="">Select Test Type</option>
                                        <option value="First CA">First CA</option>
                                        <option value="Second CA">Second CA</option>
                                        <option value="Third CA">Third CA</option>
                                        <option value="Mid-term Exam">Mid-term Exam</option>
                                        <option value="Final Exam">Final Exam</option>
                                        <option value="Quiz">Quiz</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Maximum Marks:</label>
                                    <input type="number" id="scores-max-marks" class="form-control" value="100" min="1" max="200" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Test Date:</label>
                                    <input type="date" id="scores-test-date" class="form-control" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-arrow-right"></i> Proceed to Enter Scores
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Subject Modal -->
    <div id="subject-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="subject-modal-title">Add New Subject</h3>
                <span class="close" onclick="closeSubjectModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="subject-form">
                    <div class="form-group">
                        <label for="subject-code">Subject Code:</label>
                        <input type="text" id="subject-code" class="form-control" required placeholder="e.g., MATH101">
                    </div>
                    <div class="form-group">
                        <label for="subject-name">Subject Name:</label>
                        <input type="text" id="subject-name" class="form-control" required placeholder="e.g., Mathematics">
                    </div>
                    <div class="form-group">
                        <label for="subject-description">Description:</label>
                        <textarea id="subject-description" class="form-control" rows="3" placeholder="Brief description of the subject"></textarea>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="subject-credits">Credits:</label>
                            <input type="number" id="subject-credits" class="form-control" min="1" max="10" value="3" required>
                        </div>
                        <div class="form-group">
                            <label for="subject-teacher">Assigned Teacher:</label>
                            <select id="subject-teacher" class="form-control" required>
                                <option value="">Select Teacher</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="subject-classes">Assigned Classes:</label>
                        <select id="subject-classes" class="form-control" multiple required>
                            <!-- Options will be populated dynamically -->
                        </select>
                        <small class="form-text">Hold Ctrl/Cmd to select multiple classes</small>
                    </div>
                    <div class="form-group">
                        <label for="subject-status">Status:</label>
                        <select id="subject-status" class="form-control" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSubjectModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" form="subject-form">Save Subject</button>
            </div>
        </div>
    </div>

    <!-- View Subject Details Modal -->
    <div id="subject-details-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Subject Details</h3>
                <span class="close" onclick="closeSubjectDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="subject-details-content">
                <!-- Content will be populated dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSubjectDetailsModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="printSubjectDetails()">Print Details</button>
            </div>
        </div>
    </div>

    <!-- Enhanced Backend Scripts -->
    <script src="../shared/app.js" defer></script>
    <script src="../shared/auth-manager.js" defer></script>
    <script src="../shared/script.js" defer></script>
    
    <script>
        // Subject Management JavaScript
        let editingSubjectCode = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSubjects();
            populateSubjectFilters();
            populateSubjectFormDropdowns();
            updateSubjectSummary();
            
            // Set current session/term in header
            document.getElementById('current-session').textContent = app.getActiveSession();
            document.getElementById('current-term').textContent = app.getCurrentTerm();
            
            // Add event listeners
            document.getElementById('apply-subject-filters').addEventListener('click', loadSubjects);
            document.getElementById('clear-subject-filters').addEventListener('click', clearSubjectFilters);
            document.getElementById('subject-search').addEventListener('input', loadSubjects);
            document.getElementById('subject-form').addEventListener('submit', handleSubjectFormSubmit);
            document.getElementById('scores-class').addEventListener('change', updateSubjectsForClass);
            document.getElementById('scores-entry-form').addEventListener('submit', handleScoresFormSubmit);
        });
        
        function populateSubjectFilters() {
            // Populate teacher filter
            const teacherFilter = document.getElementById('subject-filter-teacher');
            teacherFilter.innerHTML = '<option value="">All Teachers</option>';
            const teachers = app.getAllTeachers();
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                teacherFilter.appendChild(option);
            });
            
            // Populate class filter
            const classFilter = document.getElementById('subject-filter-class');
            classFilter.innerHTML = '<option value="">All Classes</option>';
            const classes = app.getUniqueClasses();
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        }
        
        function populateSubjectFormDropdowns() {
            // Populate teacher dropdown in form
            const teacherSelect = document.getElementById('subject-teacher');
            teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
            const teachers = app.getAllTeachers();
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                teacherSelect.appendChild(option);
            });
            
            // Populate classes dropdown in form
            const classesSelect = document.getElementById('subject-classes');
            classesSelect.innerHTML = '';
            const classes = app.getUniqueClasses();
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classesSelect.appendChild(option);
            });
            
            // Populate session/term dropdowns for scores
            const sessionSelect = document.getElementById('scores-session');
            sessionSelect.innerHTML = '';
            const sessions = app.getAvailableSessions();
            sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session;
                option.textContent = session;
                if (session === app.getActiveSession()) {
                    option.selected = true;
                }
                sessionSelect.appendChild(option);
            });
            
            const termSelect = document.getElementById('scores-term');
            termSelect.innerHTML = '';
            const terms = app.getAvailableTerms();
            terms.forEach(term => {
                const option = document.createElement('option');
                option.value = term;
                option.textContent = term;
                if (term === app.getCurrentTerm()) {
                    option.selected = true;
                }
                termSelect.appendChild(option);
            });
            
            // Populate class dropdown for scores
            const scoresClassSelect = document.getElementById('scores-class');
            scoresClassSelect.innerHTML = '<option value="">Choose Class</option>';
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                scoresClassSelect.appendChild(option);
            });
            
            // Set today's date as default
            document.getElementById('scores-test-date').value = new Date().toISOString().split('T')[0];
        }
        
        function loadSubjects() {
            const subjects = app.getAllSubjects();
            const teachers = app.getAllTeachers();
            const students = app.getAllStudents();
            const tbody = document.getElementById('subjects-table-body');
            
            // Apply filters
            const teacherFilter = document.getElementById('subject-filter-teacher').value;
            const classFilter = document.getElementById('subject-filter-class').value;
            const statusFilter = document.getElementById('subject-filter-status').value;
            const searchTerm = document.getElementById('subject-search').value.toLowerCase();
            
            let filteredSubjects = subjects.filter(subject => {
                if (teacherFilter && subject.teacherId !== teacherFilter) return false;
                if (statusFilter && subject.status !== statusFilter) return false;
                if (classFilter && !subject.classes.includes(classFilter)) return false;
                if (searchTerm && !subject.name.toLowerCase().includes(searchTerm) && 
                    !subject.code.toLowerCase().includes(searchTerm)) return false;
                return true;
            });
            
            tbody.innerHTML = '';
            
            if (filteredSubjects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No subjects found</td></tr>';
                return;
            }
            
            filteredSubjects.forEach(subject => {
                const teacher = teachers.find(t => t.id === subject.teacherId);
                const subjectStudents = students.filter(s => subject.classes.includes(s.class));
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${subject.code}</td>
                    <td>${subject.name}</td>
                    <td>${teacher ? teacher.name : 'Unassigned'}</td>
                    <td>${subject.classes.join(', ')}</td>
                    <td>${subject.credits}</td>
                    <td>${subjectStudents.length}</td>
                    <td><span class="status ${subject.status}">${subject.status.charAt(0).toUpperCase() + subject.status.slice(1)}</span></td>
                    <td>
                        <button class="btn-icon btn-info" onclick="viewSubjectDetails('${subject.code}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon btn-edit" onclick="editSubject('${subject.code}')" title="Edit Subject">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="deleteSubject('${subject.code}')" title="Delete Subject">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateSubjectSummary() {
            const subjects = app.getAllSubjects();
            const teachers = app.getAllTeachers();
            const activeSubjects = subjects.filter(s => s.status === 'active');
            const uniqueClasses = new Set();
            
            activeSubjects.forEach(subject => {
                subject.classes.forEach(className => uniqueClasses.add(className));
            });
            
            document.getElementById('total-subjects').textContent = activeSubjects.length;
            document.getElementById('active-teachers').textContent = teachers.filter(t => t.status === 'active').length;
            document.getElementById('classes-covered').textContent = uniqueClasses.size;
            document.getElementById('session-display').textContent = app.getActiveSession();
        }
        
        function showAddSubjectModal() {
            editingSubjectCode = null;
            document.getElementById('subject-modal-title').textContent = 'Add New Subject';
            document.getElementById('subject-form').reset();
            document.getElementById('subject-status').value = 'active';
            document.getElementById('subject-modal').style.display = 'block';
        }
        
        function editSubject(subjectCode) {
            const subject = app.getAllSubjects().find(s => s.code === subjectCode);
            if (!subject) {
                app.showNotification('Subject not found', 'error');
                return;
            }
            
            editingSubjectCode = subjectCode;
            document.getElementById('subject-modal-title').textContent = 'Edit Subject';
            document.getElementById('subject-code').value = subject.code;
            document.getElementById('subject-name').value = subject.name;
            document.getElementById('subject-description').value = subject.description || '';
            document.getElementById('subject-credits').value = subject.credits;
            document.getElementById('subject-teacher').value = subject.teacherId;
            document.getElementById('subject-status').value = subject.status;
            
            // Set selected classes
            const classesSelect = document.getElementById('subject-classes');
            Array.from(classesSelect.options).forEach(option => {
                option.selected = subject.classes.includes(option.value);
            });
            
            document.getElementById('subject-modal').style.display = 'block';
        }
        
        function handleSubjectFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const selectedClasses = Array.from(document.getElementById('subject-classes').selectedOptions)
                .map(option => option.value);
            
            const subjectData = {
                code: document.getElementById('subject-code').value,
                name: document.getElementById('subject-name').value,
                description: document.getElementById('subject-description').value,
                credits: parseInt(document.getElementById('subject-credits').value),
                teacherId: document.getElementById('subject-teacher').value,
                classes: selectedClasses,
                status: document.getElementById('subject-status').value
            };
            
            try {
                if (editingSubjectCode) {
                    // Update subject
                    app.updateSubject(editingSubjectCode, subjectData);
                    app.showNotification('Subject updated successfully!', 'success');
                } else {
                    // Create new subject
                    app.createSubject(subjectData);
                    app.showNotification('Subject created successfully!', 'success');
                }
                
                closeSubjectModal();
                loadSubjects();
                updateSubjectSummary();
            } catch (error) {
                app.showNotification('Error saving subject: ' + error.message, 'error');
            }
        }
        
        function viewSubjectDetails(subjectCode) {
            const subject = app.getAllSubjects().find(s => s.code === subjectCode);
            const teacher = app.getAllTeachers().find(t => t.id === subject.teacherId);
            const students = app.getAllStudents();
            const subjectStudents = students.filter(s => subject.classes.includes(s.class));
            
            const detailsHTML = `
                <div class="subject-details" style="line-height: 1.6;">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5>Subject Information</h5>
                            <p><strong>Code:</strong> ${subject.code}</p>
                            <p><strong>Name:</strong> ${subject.name}</p>
                            <p><strong>Credits:</strong> ${subject.credits}</p>
                            <p><strong>Status:</strong> <span class="status ${subject.status}">${subject.status}</span></p>
                        </div>
                        <div class="col-md-6">
                            <h5>Assignment Details</h5>
                            <p><strong>Teacher:</strong> ${teacher ? teacher.name : 'Unassigned'}</p>
                            <p><strong>Classes:</strong> ${subject.classes.join(', ')}</p>
                            <p><strong>Total Students:</strong> ${subjectStudents.length}</p>
                        </div>
                    </div>
                    ${subject.description ? `<div class="mb-3"><h5>Description</h5><p>${subject.description}</p></div>` : ''}
                    <div class="mb-3">
                        <h5>Students by Class</h5>
                        ${subject.classes.map(className => {
                            const classStudents = subjectStudents.filter(s => s.class === className);
                            return `<p><strong>${className}:</strong> ${classStudents.length} students</p>`;
                        }).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('subject-details-content').innerHTML = detailsHTML;
            document.getElementById('subject-details-modal').style.display = 'block';
        }
        
        function deleteSubject(subjectCode) {
            if (confirm('Are you sure you want to delete this subject? This action cannot be undone.')) {
                try {
                    app.deleteSubject(subjectCode);
                    app.showNotification('Subject deleted successfully!', 'success');
                    loadSubjects();
                    updateSubjectSummary();
                } catch (error) {
                    app.showNotification('Error deleting subject: ' + error.message, 'error');
                }
            }
        }
        
        function updateSubjectsForClass() {
            const selectedClass = document.getElementById('scores-class').value;
            const subjectSelect = document.getElementById('scores-subject');
            
            subjectSelect.innerHTML = '<option value="">Choose Subject</option>';
            
            if (selectedClass) {
                const subjects = app.getAllSubjects().filter(s => 
                    s.classes.includes(selectedClass) && s.status === 'active'
                );
                
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.code;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
            }
        }
        
        function handleScoresFormSubmit(e) {
            e.preventDefault();
            
            const session = document.getElementById('scores-session').value;
            const term = document.getElementById('scores-term').value;
            const className = document.getElementById('scores-class').value;
            const subjectCode = document.getElementById('scores-subject').value;
            const testType = document.getElementById('scores-test-type').value;
            const maxMarks = document.getElementById('scores-max-marks').value;
            const testDate = document.getElementById('scores-test-date').value;
            
            // Redirect to results page with parameters
            const params = new URLSearchParams({
                action: 'bulk_entry',
                class: className,
                subject: subjectCode,
                session: session,
                term: term,
                examType: testType,
                maxMarks: maxMarks,
                examDate: testDate
            });
            
            window.location.href = `results.html?${params.toString()}`;
        }
        
        function clearSubjectFilters() {
            document.getElementById('subject-filter-teacher').value = '';
            document.getElementById('subject-filter-class').value = '';
            document.getElementById('subject-filter-status').value = '';
            document.getElementById('subject-search').value = '';
            loadSubjects();
        }
        
        function closeSubjectModal() {
            document.getElementById('subject-modal').style.display = 'none';
            editingSubjectCode = null;
        }
        
        function closeSubjectDetailsModal() {
            document.getElementById('subject-details-modal').style.display = 'none';
        }
        
        function printSubjectDetails() {
            window.print();
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>