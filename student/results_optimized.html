<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tophill Portal - Result Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../shared/styles.css">

</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="toggle-btn" id="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h3>Tophill Portal</h3>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item" data-page="dashboard">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-page="students">
                    <i class="fas fa-users"></i>
                    <span>Students</span>
                </div>
                <div class="menu-item" data-page="teachers">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Teachers</span>
                </div>
                <div class="menu-item" data-page="subjects">
                    <i class="fas fa-book"></i>
                    <span>Subjects</span>
                </div>
                <div class="menu-item active" data-page="results">
                    <i class="fas fa-clipboard-list"></i>
                    <span>Results</span>
                </div>
                <div class="menu-item" data-page="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <a href="student-login.html" class="menu-item">
                    <i class="fas fa-user-graduate"></i>
                    <span>Student Portal</span>
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div>
                    <button class="menu-toggle" id="mobile-menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <span class="header-title">Result Management</span>
                    <div class="session-info" style="margin-left: 20px; font-size: 14px; color: #666;">
                        ðŸ“Š Session: <span id="current-session">2025-2026</span> | 
                        ðŸ“… Term: <span id="current-term">First Term</span>
                    </div>
                </div>
                <div class="user-info">
                    <button class="btn btn-primary" onclick="uploadCSV()">
                        <i class="fas fa-upload"></i> Upload CSV
                    </button>
                    <button class="btn btn-primary" onclick="downloadPDF('results')">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                    <img src="https://ui-avatars.com/api/?name=Admin+User&background=random" alt="User">
                    <span>Admin User</span>
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                </div>
            </div>

            <!-- Results Page -->
            <div class="page-content active" id="results">
                <div class="content-section">
                    <div class="section-header">
                        <div class="section-title">Result Management Dashboard</div>
                        <div class="header-actions">
                            <button class="btn btn-secondary" onclick="showBulkEntryModal()">
                                <i class="fas fa-users"></i> Bulk Entry
                            </button>
                            <button class="btn btn-primary" onclick="openAddResultModal()">
                                <i class="fas fa-plus"></i> Add Result
                            </button>
                        </div>
                    </div>
                    
                    <!-- Results Summary Dashboard -->
                    <div class="results-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="summary-icon" style="font-size: 2.5rem; margin-bottom: 10px;">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <div class="summary-title" style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">Total Results</div>
                            <div class="summary-value" style="font-size: 2rem; font-weight: 700;" id="total-results">0</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="summary-icon" style="font-size: 2.5rem; margin-bottom: 10px;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="summary-title" style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">Published</div>
                            <div class="summary-value" style="font-size: 2rem; font-weight: 700;" id="published-results">0</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="summary-icon" style="font-size: 2.5rem; margin-bottom: 10px;">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="summary-title" style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">Average Score</div>
                            <div class="summary-value" style="font-size: 2rem; font-weight: 700;" id="average-score">0%</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                            <div class="summary-icon" style="font-size: 2.5rem; margin-bottom: 10px;">
                                <i class="fas fa-medal"></i>
                            </div>
                            <div class="summary-title" style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">Excellence Rate</div>
                            <div class="summary-value" style="font-size: 2rem; font-weight: 700;" id="excellence-rate">0%</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px; color: var(--primary);">Quick Actions</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <button class="btn btn-outline-primary" onclick="generateClassReports()">
                                <i class="fas fa-file-alt"></i> Generate Class Reports
                            </button>
                            <button class="btn btn-outline-secondary" onclick="exportResults()">
                                <i class="fas fa-download"></i> Export Results
                            </button>
                            <button class="btn btn-outline-info" onclick="viewGradeAnalytics()">
                                <i class="fas fa-chart-bar"></i> Grade Analytics
                            </button>
                            <button class="btn btn-outline-success" onclick="publishAllDrafts()">
                                <i class="fas fa-upload"></i> Publish All Drafts
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced Filters -->
                    <div class="filters-section" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin-bottom: 15px; color: var(--primary);">Filter Results</h4>
                        <div class="filter-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div class="filter-group">
                                <label for="result-filter-session">Session:</label>
                                <select id="result-filter-session" class="form-control session-select auto-populate">
                                    <!-- Populated by dropdown manager -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="result-filter-term">Term:</label>
                                <select id="result-filter-term" class="form-control term-select auto-populate">
                                    <!-- Populated by dropdown manager -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="result-filter-class">Class:</label>
                                <select id="result-filter-class" class="form-control class-select auto-populate">
                                    <!-- Populated by dropdown manager -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="result-filter-subject">Subject:</label>
                                <select id="result-filter-subject" class="form-control subject-select auto-populate">
                                    <!-- Populated by dropdown manager -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="result-filter-status">Status:</label>
                                <select id="result-filter-status" class="form-control status-select auto-populate">
                                    <!-- Populated by dropdown manager -->
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="result-search">Search Student:</label>
                                <input type="text" id="result-search" class="form-control" placeholder="Search by student name...">
                            </div>
                        </div>
                        <div class="filter-actions" style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" id="apply-result-filters">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <button class="btn btn-outline-secondary" id="clear-result-filters">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    </div>

                    <div class="results-table-section" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="table-container">
                            <table class="table" id="results-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="select-all-results" onchange="toggleSelectAll()">
                                        </th>
                                        <th>Student</th>
                                        <th>Class</th>
                                        <th>Subject</th>
                                        <th>Assessment</th>
                                        <th>Score</th>
                                        <th>Grade</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body">
                                    <!-- Dynamic content will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Bulk Actions -->
                        <div class="bulk-actions" style="margin: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; display: none;" id="bulk-actions">
                            <strong>Bulk Actions:</strong>
                            <button class="btn btn-sm btn-success" onclick="bulkPublish()">Publish Selected</button>
                            <button class="btn btn-sm btn-warning" onclick="bulkUnpublish()">Unpublish Selected</button>
                            <button class="btn btn-sm btn-danger" onclick="bulkDelete()">Delete Selected</button>
                        </div>

                        <!-- Enhanced Pagination -->
                        <div class="pagination-container" style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                            <div class="pagination-info">
                                Showing <span id="results-start">1</span> to <span id="results-end">10</span> of <span id="results-total">0</span> results
                            </div>
                            <div class="pagination-controls">
                                <button class="btn btn-sm btn-secondary" id="prev-page" onclick="previousPage()" disabled>Previous</button>
                                <span class="pagination-pages" id="pagination-pages"></span>
                                <button class="btn btn-sm btn-secondary" id="next-page" onclick="nextPage()">Next</button>
                            </div>
                            <div class="page-size-selector">
                                <label>Per page:</label>
                                <select id="page-size" onchange="changePageSize()">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Entry Modal -->
    <div id="bulk-entry-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Bulk Result Entry</h3>
                <span class="close" onclick="closeBulkEntryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="bulk-entry-setup">
                    <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="bulk-session">Session:</label>
                            <select id="bulk-session" class="form-control session-select auto-populate" required>
                                <!-- Populated by dropdown manager -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bulk-term">Term:</label>
                            <select id="bulk-term" class="form-control term-select auto-populate" required>
                                <!-- Populated by dropdown manager -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bulk-class">Class:</label>
                            <select id="bulk-class" class="form-control class-select auto-populate" required onchange="updateBulkSubjects()">
                                <!-- Populated by dropdown manager -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bulk-subject">Subject:</label>
                            <select id="bulk-subject" class="form-control subject-select auto-populate" required>
                                <!-- Populated by dropdown manager -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="bulk-assessment">Assessment Type:</label>
                            <select id="bulk-assessment" class="form-control" required>
                                <option value="First CA">First CA</option>
                                <option value="Second CA">Second CA</option>
                                <option value="Third CA">Third CA</option>
                                <option value="Mid-term Exam">Mid-term Exam</option>
                                <option value="Final Exam">Final Exam</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="bulk-max-score">Maximum Score:</label>
                            <input type="number" id="bulk-max-score" class="form-control" min="1" max="100" value="100" required>
                        </div>
                        <div class="form-group">
                            <label for="bulk-exam-date">Exam Date:</label>
                            <input type="date" id="bulk-exam-date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-primary" onclick="loadStudentsForBulkEntry()">Load Students</button>
                        </div>
                    </div>
                </div>
                
                <div class="bulk-students-section" id="bulk-students-section" style="display: none;">
                    <h4>Enter Scores for Students</h4>
                    <div class="bulk-actions-header" style="margin-bottom: 15px;">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="fillAllScores()">Fill All with Same Score</button>
                        <button type="button" class="btn btn-sm btn-info" onclick="generateRandomScores()">Generate Sample Scores</button>
                    </div>
                    <div id="bulk-students-list" class="students-grid" style="max-height: 400px; overflow-y: auto;">
                        <!-- Student score inputs will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBulkEntryModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveBulkResults()" id="save-bulk-results" disabled>Save All Results</button>
            </div>
        </div>
    </div>

    <!-- Add Result Modal -->
    <div id="add-result-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Result</h3>
                <span class="close" onclick="closeAddResultModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="result-form">
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="resultStudent">Student:</label>
                            <select id="resultStudent" class="form-control" required>
                                <option value="">Select Student</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resultSubject">Subject:</label>
                            <select id="resultSubject" class="form-control" required>
                                <option value="">Select Subject</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="resultSession">Session:</label>
                            <select id="resultSession" class="form-control" required>
                                <!-- Options populated dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resultTerm">Term:</label>
                            <select id="resultTerm" class="form-control" required>
                                <!-- Options populated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="resultType">Assessment Type:</label>
                            <select id="resultType" class="form-control" required>
                                <option value="First CA">First CA</option>
                                <option value="Second CA">Second CA</option>
                                <option value="Third CA">Third CA</option>
                                <option value="Mid-term Exam">Mid-term Exam</option>
                                <option value="Final Exam">Final Exam</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="resultDate">Exam Date:</label>
                            <input type="date" id="resultDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="resultMaxMarks">Maximum Score:</label>
                            <input type="number" id="resultMaxMarks" class="form-control" min="1" max="100" value="100" required>
                        </div>
                        <div class="form-group">
                            <label for="resultMarks">Student Score:</label>
                            <input type="number" id="resultMarks" class="form-control" min="0" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddResultModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" form="result-form">Save Result</button>
            </div>
        </div>
    </div>

    <!-- Enhanced Backend Scripts -->
    <script src="../shared/app.js" defer></script>
    <script src="../shared/auth-manager.js" defer></script>
    <script src="../shared/result-manager.js" defer></script>
    <script src="../shared/dropdown-manager.js" defer></script>
    <script src="../shared/script.js"></script>
    
    <script>
        // Global variables
        let currentPage = 1;
        let pageSize = 10;
        let totalResults = 0;
        let selectedResults = new Set();
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadResults();
            populateResultFilters();
            populateResultFormDropdowns();
            updateResultsSummary();
            
            // Set current session/term in header
            document.getElementById('current-session').textContent = app.getActiveSession();
            document.getElementById('current-term').textContent = app.getCurrentTerm();
            
            // Add event listeners
            document.getElementById('apply-result-filters').addEventListener('click', () => {
                currentPage = 1;
                loadResults();
            });
            document.getElementById('clear-result-filters').addEventListener('click', clearResultFilters);
            document.getElementById('result-search').addEventListener('input', () => {
                currentPage = 1;
                loadResults();
            });
            document.getElementById('result-form').addEventListener('submit', handleResultFormSubmit);
            
            // Set today's date as default
            document.getElementById('bulk-exam-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('resultDate').value = new Date().toISOString().split('T')[0];
        });
        
        function updateResultsSummary() {
            const stats = app.getResultStatistics();
            const excellenceCount = (stats.gradeDistribution?.['A+'] || 0) + (stats.gradeDistribution?.['A'] || 0);
            const excellenceRate = stats.totalResults > 0 ? Math.round((excellenceCount / stats.totalResults) * 100) : 0;
            
            document.getElementById('total-results').textContent = stats.totalResults || 0;
            document.getElementById('published-results').textContent = stats.publishedResults || 0;
            document.getElementById('average-score').textContent = (stats.averageScore || 0) + '%';
            document.getElementById('excellence-rate').textContent = excellenceRate + '%';
        }
        
        function loadResults() {
            let results = app.getAllResults();
            
            // Apply filters
            const classFilter = document.getElementById('result-filter-class')?.value;
            const subjectFilter = document.getElementById('result-filter-subject')?.value;
            const termFilter = document.getElementById('result-filter-term')?.value;
            const sessionFilter = document.getElementById('result-filter-session')?.value;
            const statusFilter = document.getElementById('result-filter-status')?.value;
            const studentSearch = document.getElementById('result-search')?.value?.toLowerCase();
            
            if (classFilter) {
                results = results.filter(r => r.studentClass === classFilter);
            }
            if (subjectFilter) {
                results = results.filter(r => r.subjectCode === subjectFilter);
            }
            if (termFilter) {
                results = results.filter(r => r.term === termFilter);
            }
            if (sessionFilter) {
                results = results.filter(r => r.session === sessionFilter);
            }
            if (statusFilter) {
                results = results.filter(r => r.status === statusFilter);
            }
            if (studentSearch) {
                results = results.filter(r => r.studentName.toLowerCase().includes(studentSearch));
            }
            
            totalResults = results.length;
            
            // Pagination
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, totalResults);
            const paginatedResults = results.slice(startIndex, endIndex);
            
            // Update pagination info
            document.getElementById('results-start').textContent = totalResults > 0 ? startIndex + 1 : 0;
            document.getElementById('results-end').textContent = endIndex;
            document.getElementById('results-total').textContent = totalResults;
            
            // Update pagination controls
            const totalPages = Math.ceil(totalResults / pageSize);
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
            
            // Update page numbers
            const pagesDiv = document.getElementById('pagination-pages');
            pagesDiv.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-secondary'}`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    currentPage = i;
                    loadResults();
                };
                pageBtn.style.marginRight = '5px';
                pagesDiv.appendChild(pageBtn);
            }
            
            // Populate table
            const tbody = document.getElementById('results-table-body');
            tbody.innerHTML = '';
            
            if (paginatedResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">No results found</td></tr>';
                return;
            }
            
            paginatedResults.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="result-checkbox" data-result-id="${result.id}" 
                               onchange="toggleResultSelection('${result.id}')">
                    </td>
                    <td>${result.studentName}</td>
                    <td>${result.studentClass}</td>
                    <td>${result.subjectName}</td>
                    <td>${result.assessmentType}</td>
                    <td>${result.score}/${result.maxScore} (${result.percentage}%)</td>
                    <td><span class="grade-badge grade-${result.grade.toLowerCase().replace('+', 'plus')}">${result.grade}</span></td>
                    <td>${new Date(result.examDate).toLocaleDateString()}</td>
                    <td><span class="status ${result.status}">${result.status.charAt(0).toUpperCase() + result.status.slice(1)}</span></td>
                    <td>
                        <button class="btn-icon btn-info" onclick="viewResultDetails('${result.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon btn-edit" onclick="editResult('${result.id}')" title="Edit Result">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${result.status === 'draft' ? 
                            `<button class="btn-icon btn-success" onclick="publishResult('${result.id}')" title="Publish Result">
                                <i class="fas fa-upload"></i>
                            </button>` : 
                            `<button class="btn-icon btn-warning" onclick="unpublishResult('${result.id}')" title="Unpublish Result">
                                <i class="fas fa-download"></i>
                            </button>`
                        }
                        <button class="btn-icon btn-delete" onclick="deleteResult('${result.id}')" title="Delete Result">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function populateResultFilters() {
            // Populate session filter
            const sessionFilter = document.getElementById('result-filter-session');
            sessionFilter.innerHTML = '<option value="">All Sessions</option>';
            const sessions = app.getAvailableSessions();
            sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session;
                option.textContent = session;
                sessionFilter.appendChild(option);
            });
            
            // Populate term filter
            const termFilter = document.getElementById('result-filter-term');
            termFilter.innerHTML = '<option value="">All Terms</option>';
            const terms = app.getAvailableTerms();
            terms.forEach(term => {
                const option = document.createElement('option');
                option.value = term;
                option.textContent = term;
                termFilter.appendChild(option);
            });
            
            // Populate class filter
            const classFilter = document.getElementById('result-filter-class');
            classFilter.innerHTML = '<option value="">All Classes</option>';
            const classes = app.getUniqueClasses();
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
            
            // Populate subject filter
            const subjectFilter = document.getElementById('result-filter-subject');
            subjectFilter.innerHTML = '<option value="">All Subjects</option>';
            const subjects = app.getAllSubjects();
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.code;
                option.textContent = subject.name;
                subjectFilter.appendChild(option);
            });
        }
        
        function populateResultFormDropdowns() {
            // Populate student dropdown
            const studentSelect = document.getElementById('resultStudent');
            studentSelect.innerHTML = '<option value="">Select Student</option>';
            const students = app.getAllStudents();
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.class})`;
                studentSelect.appendChild(option);
            });
            
            // Populate subject dropdown
            const subjectSelect = document.getElementById('resultSubject');
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            const subjects = app.getAllSubjects();
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.code;
                option.textContent = subject.name;
                subjectSelect.appendChild(option);
            });
            
            // Populate session dropdown
            const sessionSelect = document.getElementById('resultSession');
            sessionSelect.innerHTML = '';
            const sessions = app.getAvailableSessions();
            sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session;
                option.textContent = session;
                if (session === app.getActiveSession()) {
                    option.selected = true;
                }
                sessionSelect.appendChild(option);
            });
            
            // Populate term dropdown
            const termSelect = document.getElementById('resultTerm');
            termSelect.innerHTML = '';
            const terms = app.getAvailableTerms();
            terms.forEach(term => {
                const option = document.createElement('option');
                option.value = term;
                option.textContent = term;
                if (term === app.getCurrentTerm()) {
                    option.selected = true;
                }
                termSelect.appendChild(option);
            });
        }
        
        // Bulk Entry Functions
        function showBulkEntryModal() {
            populateBulkEntryDropdowns();
            document.getElementById('bulk-entry-modal').style.display = 'block';
        }
        
        function closeBulkEntryModal() {
            document.getElementById('bulk-entry-modal').style.display = 'none';
            document.getElementById('bulk-students-section').style.display = 'none';
            document.getElementById('save-bulk-results').disabled = true;
        }
        
        function populateBulkEntryDropdowns() {
            // Populate session dropdown
            const sessionSelect = document.getElementById('bulk-session');
            sessionSelect.innerHTML = '';
            const sessions = app.getAvailableSessions();
            sessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session;
                option.textContent = session;
                if (session === app.getActiveSession()) {
                    option.selected = true;
                }
                sessionSelect.appendChild(option);
            });
            
            // Populate term dropdown
            const termSelect = document.getElementById('bulk-term');
            termSelect.innerHTML = '';
            const terms = app.getAvailableTerms();
            terms.forEach(term => {
                const option = document.createElement('option');
                option.value = term;
                option.textContent = term;
                if (term === app.getCurrentTerm()) {
                    option.selected = true;
                }
                termSelect.appendChild(option);
            });
            
            // Populate class dropdown
            const classSelect = document.getElementById('bulk-class');
            classSelect.innerHTML = '<option value="">Select Class</option>';
            const classes = app.getUniqueClasses();
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classSelect.appendChild(option);
            });
        }
        
        function updateBulkSubjects() {
            const selectedClass = document.getElementById('bulk-class').value;
            const subjectSelect = document.getElementById('bulk-subject');
            
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            
            if (selectedClass) {
                const subjects = app.getSubjectsByClass(selectedClass);
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.code;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
            }
        }
        
        function loadStudentsForBulkEntry() {
            const className = document.getElementById('bulk-class').value;
            const subjectCode = document.getElementById('bulk-subject').value;
            
            if (!className || !subjectCode) {
                app.showNotification('Please select class and subject first', 'warning');
                return;
            }
            
            const students = app.getStudentsByClass(className);
            const studentsListDiv = document.getElementById('bulk-students-list');
            
            studentsListDiv.innerHTML = '';
            
            students.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'student-score-input';
                studentDiv.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px;';
                
                studentDiv.innerHTML = `
                    <div style="flex: 1; font-weight: 500;">${student.name}</div>
                    <div style="flex: 0 0 100px;">
                        <input type="number" class="form-control student-score" 
                               data-student-id="${student.id}" 
                               min="0" max="${document.getElementById('bulk-max-score').value}" 
                               placeholder="Score" 
                               style="width: 100%;">
                    </div>
                    <div style="flex: 0 0 80px; text-align: center; font-size: 0.9rem; color: #666;" class="calculated-grade">-</div>
                `;
                
                studentsListDiv.appendChild(studentDiv);
            });
            
            // Add input event listeners to calculate grades
            document.querySelectorAll('.student-score').forEach(input => {
                input.addEventListener('input', function() {
                    const score = parseInt(this.value) || 0;
                    const maxScore = parseInt(document.getElementById('bulk-max-score').value);
                    const grade = app.calculateGrade(score, maxScore);
                    const gradeDiv = this.parentElement.nextElementSibling;
                    gradeDiv.textContent = this.value ? grade.letter : '-';
                });
            });
            
            document.getElementById('bulk-students-section').style.display = 'block';
            document.getElementById('save-bulk-results').disabled = false;
        }
        
        function fillAllScores() {
            const score = prompt('Enter score for all students:');
            if (score && !isNaN(score)) {
                const maxScore = parseInt(document.getElementById('bulk-max-score').value);
                if (parseInt(score) <= maxScore) {
                    document.querySelectorAll('.student-score').forEach(input => {
                        input.value = score;
                        input.dispatchEvent(new Event('input'));
                    });
                } else {
                    app.showNotification('Score cannot exceed maximum score', 'error');
                }
            }
        }
        
        function generateRandomScores() {
            const maxScore = parseInt(document.getElementById('bulk-max-score').value);
            document.querySelectorAll('.student-score').forEach(input => {
                // Generate realistic scores (60-95% range)
                const minScore = Math.floor(maxScore * 0.6);
                const range = Math.floor(maxScore * 0.35);
                const score = minScore + Math.floor(Math.random() * range);
                input.value = score;
                input.dispatchEvent(new Event('input'));
            });
        }
        
        function saveBulkResults() {
            const session = document.getElementById('bulk-session').value;
            const term = document.getElementById('bulk-term').value;
            const className = document.getElementById('bulk-class').value;
            const subjectCode = document.getElementById('bulk-subject').value;
            const assessmentType = document.getElementById('bulk-assessment').value;
            const maxScore = parseInt(document.getElementById('bulk-max-score').value);
            const examDate = document.getElementById('bulk-exam-date').value;
            
            const studentScores = [];
            document.querySelectorAll('.student-score').forEach(input => {
                if (input.value) {
                    studentScores.push({
                        studentId: input.dataset.studentId,
                        score: parseInt(input.value),
                        examDate: examDate
                    });
                }
            });
            
            if (studentScores.length === 0) {
                app.showNotification('Please enter at least one score', 'warning');
                return;
            }
            
            try {
                // Create results individually since bulkCreateResults might not exist
                let successCount = 0;
                studentScores.forEach(scoreData => {
                    try {
                        app.createResult({
                            studentId: scoreData.studentId,
                            subjectCode,
                            assessmentType,
                            maxScore,
                            score: scoreData.score,
                            session,
                            term,
                            examDate: scoreData.examDate,
                            status: 'draft'
                        });
                        successCount++;
                    } catch (error) {
                        console.error('Error creating result:', error);
                    }
                });
                
                app.showNotification(`Successfully created ${successCount} results!`, 'success');
                closeBulkEntryModal();
                loadResults();
                updateResultsSummary();
            } catch (error) {
                app.showNotification('Error creating bulk results: ' + error.message, 'error');
            }
        }
        
        // Result Management Functions
        function openAddResultModal() {
            document.getElementById('result-form').reset();
            document.querySelector('#add-result-modal h3').textContent = 'Add New Result';
            document.getElementById('add-result-modal').removeAttribute('data-editing-id');
            document.getElementById('resultDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('add-result-modal').style.display = 'block';
        }
        
        function closeAddResultModal() {
            document.getElementById('add-result-modal').style.display = 'none';
        }
        
        function handleResultFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                studentId: document.getElementById('resultStudent').value,
                subjectCode: document.getElementById('resultSubject').value,
                session: document.getElementById('resultSession').value,
                term: document.getElementById('resultTerm').value,
                assessmentType: document.getElementById('resultType').value,
                maxScore: parseInt(document.getElementById('resultMaxMarks').value),
                score: parseInt(document.getElementById('resultMarks').value),
                examDate: document.getElementById('resultDate').value,
                status: 'draft'
            };
            
            try {
                const editingId = document.getElementById('add-result-modal').dataset.editingId;
                if (editingId) {
                    app.updateResult(editingId, formData);
                } else {
                    app.createResult(formData);
                }
                
                closeAddResultModal();
                loadResults();
                updateResultsSummary();
            } catch (error) {
                app.showNotification('Error saving result: ' + error.message, 'error');
            }
        }
        
        function editResult(resultId) {
            const result = app.getAllResults().find(r => r.id === resultId);
            if (!result) {
                app.showNotification('Result not found', 'error');
                return;
            }
            
            // Populate edit form
            document.getElementById('resultStudent').value = result.studentId;
            document.getElementById('resultSubject').value = result.subjectCode;
            document.getElementById('resultTerm').value = result.term;
            document.getElementById('resultSession').value = result.session;
            document.getElementById('resultType').value = result.assessmentType;
            document.getElementById('resultMaxMarks').value = result.maxScore;
            document.getElementById('resultMarks').value = result.score;
            document.getElementById('resultDate').value = result.examDate;
            
            // Set modal title and show
            document.querySelector('#add-result-modal h3').textContent = 'Edit Result';
            document.getElementById('add-result-modal').style.display = 'block';
            
            // Store result ID for update
            document.getElementById('add-result-modal').dataset.editingId = resultId;
        }
        
        function deleteResult(resultId) {
            if (confirm('Are you sure you want to delete this result? This action cannot be undone.')) {
                try {
                    app.deleteResult(resultId);
                    loadResults();
                    updateResultsSummary();
                } catch (error) {
                    app.showNotification('Error deleting result: ' + error.message, 'error');
                }
            }
        }
        
        function publishResult(resultId) {
            if (confirm('Are you sure you want to publish this result?')) {
                const result = app.updateResult(resultId, { status: 'published' });
                if (result) {
                    loadResults();
                    updateResultsSummary();
                }
            }
        }
        
        function unpublishResult(resultId) {
            if (confirm('Are you sure you want to unpublish this result?')) {
                const result = app.updateResult(resultId, { status: 'draft', publishDate: null });
                if (result) {
                    loadResults();
                    updateResultsSummary();
                }
            }
        }
        
        function viewResultDetails(resultId) {
            const result = app.getAllResults().find(r => r.id === resultId);
            if (!result) {
                app.showNotification('Result not found', 'error');
                return;
            }
            
            const detailsHTML = `
                <div class="result-details" style="line-height: 1.6;">
                    <div class="row mb-3" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h5>Student Information</h5>
                            <p><strong>Name:</strong> ${result.studentName}</p>
                            <p><strong>Class:</strong> ${result.studentClass}</p>
                            <p><strong>Student ID:</strong> ${result.studentId}</p>
                        </div>
                        <div>
                            <h5>Assessment Details</h5>
                            <p><strong>Subject:</strong> ${result.subjectName}</p>
                            <p><strong>Assessment:</strong> ${result.assessmentType}</p>
                            <p><strong>Date:</strong> ${new Date(result.examDate).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <div class="row mb-3" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h5>Score Details</h5>
                            <p><strong>Score:</strong> ${result.score}/${result.maxScore}</p>
                            <p><strong>Percentage:</strong> ${result.percentage}%</p>
                            <p><strong>Grade:</strong> <span class="grade-badge grade-${result.grade.toLowerCase().replace('+', 'plus')}">${result.grade}</span></p>
                            <p><strong>Remark:</strong> ${result.remark}</p>
                        </div>
                        <div>
                            <h5>Status Information</h5>
                            <p><strong>Status:</strong> <span class="status ${result.status}">${result.status.charAt(0).toUpperCase() + result.status.slice(1)}</span></p>
                            <p><strong>Session:</strong> ${result.session}</p>
                            <p><strong>Term:</strong> ${result.term}</p>
                            ${result.publishDate ? `<p><strong>Published:</strong> ${new Date(result.publishDate).toLocaleDateString()}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Create and show details modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Result Details</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        ${detailsHTML}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        <button type="button" class="btn btn-primary" onclick="window.print()">Print Details</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Selection and Bulk Actions
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all-results');
            const checkboxes = document.querySelectorAll('.result-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedResults.add(checkbox.dataset.resultId);
                } else {
                    selectedResults.delete(checkbox.dataset.resultId);
                }
            });
            
            updateBulkActionsVisibility();
        }
        
        function toggleResultSelection(resultId) {
            const checkbox = document.querySelector(`[data-result-id="${resultId}"]`);
            if (checkbox.checked) {
                selectedResults.add(resultId);
            } else {
                selectedResults.delete(resultId);
            }
            updateBulkActionsVisibility();
        }
        
        function updateBulkActionsVisibility() {
            const bulkActions = document.getElementById('bulk-actions');
            bulkActions.style.display = selectedResults.size > 0 ? 'block' : 'none';
        }
        
        function bulkPublish() {
            if (selectedResults.size === 0) return;
            
            if (confirm(`Publish ${selectedResults.size} selected results?`)) {
                selectedResults.forEach(resultId => {
                    app.updateResult(resultId, { status: 'published' });
                });
                app.showNotification(`Published ${selectedResults.size} results!`, 'success');
                selectedResults.clear();
                loadResults();
                updateResultsSummary();
                updateBulkActionsVisibility();
            }
        }
        
        function bulkUnpublish() {
            if (selectedResults.size === 0) return;
            
            if (confirm(`Unpublish ${selectedResults.size} selected results?`)) {
                selectedResults.forEach(resultId => {
                    app.updateResult(resultId, { status: 'draft', publishDate: null });
                });
                app.showNotification(`Unpublished ${selectedResults.size} results!`, 'success');
                selectedResults.clear();
                loadResults();
                updateResultsSummary();
                updateBulkActionsVisibility();
            }
        }
        
        function bulkDelete() {
            if (selectedResults.size === 0) return;
            
            if (confirm(`Delete ${selectedResults.size} selected results? This action cannot be undone.`)) {
                selectedResults.forEach(resultId => {
                    app.deleteResult(resultId);
                });
                app.showNotification(`Deleted ${selectedResults.size} results!`, 'success');
                selectedResults.clear();
                loadResults();
                updateResultsSummary();
                updateBulkActionsVisibility();
            }
        }
        
        // Quick Actions
        function generateClassReports() {
            app.showNotification('Generating class reports...', 'info');
            // Implementation for generating class reports
        }
        
        function exportResults() {
            app.showNotification('Exporting results...', 'info');
            // Implementation for exporting results
        }
        
        function viewGradeAnalytics() {
            app.showNotification('Opening grade analytics...', 'info');
            // Implementation for grade analytics
        }
        
        function publishAllDrafts() {
            const draftResults = app.getAllResults().filter(r => r.status === 'draft');
            if (draftResults.length === 0) {
                app.showNotification('No draft results to publish', 'info');
                return;
            }
            
            if (confirm(`Publish ${draftResults.length} draft results?`)) {
                draftResults.forEach(result => {
                    app.updateResult(result.id, { status: 'published' });
                });
                app.showNotification(`Published ${draftResults.length} results!`, 'success');
                loadResults();
                updateResultsSummary();
            }
        }
        
        // Pagination Functions
        function changePageSize() {
            pageSize = parseInt(document.getElementById('page-size').value);
            currentPage = 1;
            loadResults();
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadResults();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(totalResults / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                loadResults();
            }
        }
        
        function clearResultFilters() {
            document.getElementById('result-filter-class').value = '';
            document.getElementById('result-filter-subject').value = '';
            document.getElementById('result-filter-term').value = '';
            document.getElementById('result-filter-session').value = '';
            document.getElementById('result-filter-status').value = '';
            document.getElementById('result-search').value = '';
            currentPage = 1;
            loadResults();
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // CSV upload and PDF download functions (placeholder)
        function uploadCSV() {
            document.getElementById('csvFileInput').click();
        }
        
        function downloadPDF(type) {
            app.showNotification('Generating PDF...', 'info');
        }
    </script>
    
    <style>
        /* Grade badges */
        .grade-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .grade-aplus { background: #dcfce7; color: #059669; }
        .grade-a { background: #dbeafe; color: #0284c7; }
        .grade-bplus { background: #fef3c7; color: #d97706; }
        .grade-b { background: #fde68a; color: #f59e0b; }
        .grade-cplus { background: #fed7aa; color: #ea580c; }
        .grade-c { background: #fecaca; color: #dc2626; }
        .grade-dplus { background: #fecaca; color: #dc2626; }
        .grade-d { background: #fecaca; color: #dc2626; }
        .grade-f { background: #fee2e2; color: #991b1b; }
        
        /* Enhanced table styles */
        .table-container {
            overflow-x: auto;
        }
        
        .table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            padding: 12px 8px;
            text-align: left;
            border: none;
            white-space: nowrap;
        }
        
        .table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.85rem;
            vertical-align: middle;
        }
        
        .table tbody tr:hover {
            background: #f8fafc;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .results-summary {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .quick-actions > div {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .table th:nth-child(n+6),
            .table td:nth-child(n+6) {
                display: none;
            }
            
            .session-info {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .results-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>